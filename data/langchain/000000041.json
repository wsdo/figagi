{
	"title": "SQL Database | ü¶úÔ∏èüîó Langchain",
	"url": "https://python.langchain.com/docs/integrations/toolkits/sql_database",
	"html": "Skip to main content\nü¶úÔ∏èüîó LangChain\nDocs\nUse cases\nIntegrations\nGuides\nAPI\nMore\nü¶úÔ∏èüîó\nChat\nSearch\n‚åò\nK\nProviders\nAnthropic\nAWS\nGoogle\nHugging Face\nMicrosoft\nOpenAI\nMore\nComponents\nLLMs\nChat models\nDocument loaders\nDocument transformers\nText embedding models\nVector stores\nRetrievers\nTools\nAgents and toolkits\nAINetwork\nAirbyte Question Answering\nAmadeus\nAzure Cognitive Services\nClickUp\nCSV\nDocument Comparison\nGithub\nGitlab\nGmail\nGoogle Drive tool\nJira\nJSON\nMultiOn\nNASA\nOffice365\nOpenAPI\nNatural Language APIs\nPandas Dataframe\nPlayWright Browser\nPowerBI Dataset\nPython\nSlack\nSpark Dataframe\nSpark SQL\nSQL Database\nSteam Game Recommendation & Game Details Tool\nXorbits\nMemory\nCallbacks\nChat loaders\nAdapters\nStores\nComponentsAgents and toolkitsSQL Database\nSQL Database\n\nThis notebook showcases an agent designed to interact with a SQL databases. The agent builds off of SQLDatabaseChain and is designed to answer more general questions about a database, as well as recover from errors.\n\nNote that, as this agent is in active development, all answers might not be correct. Additionally, it is not guaranteed that the agent won‚Äôt perform DML statements on your database given certain questions. Be careful running it on sensitive data!\n\nThis uses the example Chinook database. To set it up follow the instructions on https://database.guide/2-sample-databases-sqlite/, placing the .db file in a notebooks folder at the root of this repository.\n\nInitialization‚Äã\nfrom langchain.agents import create_sql_agent\nfrom langchain.agents.agent_toolkits import SQLDatabaseToolkit\nfrom langchain.agents.agent_types import AgentType\nfrom langchain.llms.openai import OpenAI\nfrom langchain.sql_database import SQLDatabase\n\ndb = SQLDatabase.from_uri(\"sqlite:///../../../../../notebooks/Chinook.db\")\ntoolkit = SQLDatabaseToolkit(db=db, llm=OpenAI(temperature=0))\n\nUsing ZERO_SHOT_REACT_DESCRIPTION‚Äã\n\nThis shows how to initialize the agent using the ZERO_SHOT_REACT_DESCRIPTION agent type.\n\nagent_executor = create_sql_agent(\n    llm=OpenAI(temperature=0),\n    toolkit=toolkit,\n    verbose=True,\n    agent_type=AgentType.ZERO_SHOT_REACT_DESCRIPTION,\n)\n\nUsing OpenAI Functions‚Äã\n\nThis shows how to initialize the agent using the OPENAI_FUNCTIONS agent type. Note that this is an alternative to the above.\n\n# agent_executor = create_sql_agent(\n#     llm=ChatOpenAI(temperature=0, model=\"gpt-3.5-turbo-0613\"),\n#     toolkit=toolkit,\n#     verbose=True,\n#     agent_type=AgentType.OPENAI_FUNCTIONS\n# )\n\nDisclaimer ‚ö†Ô∏è‚Äã\n\nThe query chain may generate insert/update/delete queries. When this is not expected, use a custom prompt or create a SQL users without write permissions.\n\nThe final user might overload your SQL database by asking a simple question such as ‚Äúrun the biggest query possible‚Äù. The generated query might look like:\n\nSELECT * FROM \"public\".\"users\"\n    JOIN \"public\".\"user_permissions\" ON \"public\".\"users\".id = \"public\".\"user_permissions\".user_id\n    JOIN \"public\".\"projects\" ON \"public\".\"users\".id = \"public\".\"projects\".user_id\n    JOIN \"public\".\"events\" ON \"public\".\"projects\".id = \"public\".\"events\".project_id;\n\n\nFor a transactional SQL database, if one of the table above contains millions of rows, the query might cause trouble to other applications using the same database.\n\nMost datawarehouse oriented databases support user-level quota, for limiting resource usage.\n\nExample: describing a table‚Äã\nagent_executor.run(\"Describe the playlisttrack table\")\n\n\n\n> Entering new  chain...\n\nInvoking: `list_tables_sql_db` with `{}`\n\n\nAlbum, Artist, Track, PlaylistTrack, InvoiceLine, sales_table, Playlist, Genre, Employee, Customer, Invoice, MediaType\nInvoking: `schema_sql_db` with `PlaylistTrack`\n\n\n\nCREATE TABLE \"PlaylistTrack\" (\n    \"PlaylistId\" INTEGER NOT NULL, \n    \"TrackId\" INTEGER NOT NULL, \n    PRIMARY KEY (\"PlaylistId\", \"TrackId\"), \n    FOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \n    FOREIGN KEY(\"PlaylistId\") REFERENCES \"Playlist\" (\"PlaylistId\")\n)\n\n/*\n3 rows from PlaylistTrack table:\nPlaylistId  TrackId\n1   3402\n1   3389\n1   3390\n*/The `PlaylistTrack` table has two columns: `PlaylistId` and `TrackId`. It is a junction table that represents the relationship between playlists and tracks. \n\nHere is the schema of the `PlaylistTrack` table:\n\n```\nCREATE TABLE \"PlaylistTrack\" (\n    \"PlaylistId\" INTEGER NOT NULL, \n    \"TrackId\" INTEGER NOT NULL, \n    PRIMARY KEY (\"PlaylistId\", \"TrackId\"), \n    FOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \n    FOREIGN KEY(\"PlaylistId\") REFERENCES \"Playlist\" (\"PlaylistId\")\n)\n```\n\nHere are three sample rows from the `PlaylistTrack` table:\n\n```\nPlaylistId   TrackId\n1            3402\n1            3389\n1            3390\n```\n\nPlease let me know if there is anything else I can help you with.\n\n> Finished chain.\n\n'The `PlaylistTrack` table has two columns: `PlaylistId` and `TrackId`. It is a junction table that represents the relationship between playlists and tracks. \\n\\nHere is the schema of the `PlaylistTrack` table:\\n\\n```\\nCREATE TABLE \"PlaylistTrack\" (\\n\\t\"PlaylistId\" INTEGER NOT NULL, \\n\\t\"TrackId\" INTEGER NOT NULL, \\n\\tPRIMARY KEY (\"PlaylistId\", \"TrackId\"), \\n\\tFOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \\n\\tFOREIGN KEY(\"PlaylistId\") REFERENCES \"Playlist\" (\"PlaylistId\")\\n)\\n```\\n\\nHere are three sample rows from the `PlaylistTrack` table:\\n\\n```\\nPlaylistId   TrackId\\n1            3402\\n1            3389\\n1            3390\\n```\\n\\nPlease let me know if there is anything else I can help you with.'\n\nExample: describing a table, recovering from an error‚Äã\n\nIn this example, the agent tries to search for a table that doesn‚Äôt exist, but finds the next best result\n\nagent_executor.run(\"Describe the playlistsong table\")\n\n\n\n> Entering new AgentExecutor chain...\nAction: list_tables_sql_db\nAction Input: \"\"\nObservation: Genre, PlaylistTrack, MediaType, Invoice, InvoiceLine, Track, Playlist, Customer, Album, Employee, Artist\nThought: I should look at the schema of the PlaylistSong table\nAction: schema_sql_db\nAction Input: \"PlaylistSong\"\nObservation: Error: table_names {'PlaylistSong'} not found in database\nThought: I should check the spelling of the table\nAction: list_tables_sql_db\nAction Input: \"\"\nObservation: Genre, PlaylistTrack, MediaType, Invoice, InvoiceLine, Track, Playlist, Customer, Album, Employee, Artist\nThought: The table is called PlaylistTrack\nAction: schema_sql_db\nAction Input: \"PlaylistTrack\"\nObservation: \nCREATE TABLE \"PlaylistTrack\" (\n    \"PlaylistId\" INTEGER NOT NULL, \n    \"TrackId\" INTEGER NOT NULL, \n    PRIMARY KEY (\"PlaylistId\", \"TrackId\"), \n    FOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \n    FOREIGN KEY(\"PlaylistId\") REFERENCES \"Playlist\" (\"PlaylistId\")\n)\n\nSELECT * FROM 'PlaylistTrack' LIMIT 3;\nPlaylistId TrackId\n1 3402\n1 3389\n1 3390\nThought: I now know the final answer\nFinal Answer: The PlaylistTrack table contains two columns, PlaylistId and TrackId, which are both integers and are used to link Playlist and Track tables.\n\n> Finished chain.\n\n'The PlaylistTrack table contains two columns, PlaylistId and TrackId, which are both integers and are used to link Playlist and Track tables.'\n\nExample: running queries‚Äã\nagent_executor.run(\n    \"List the total sales per country. Which country's customers spent the most?\"\n)\n\n\n\n> Entering new AgentExecutor chain...\nAction: list_tables_sql_db\nAction Input: \"\"\nObservation: Invoice, MediaType, Artist, InvoiceLine, Genre, Playlist, Employee, Album, PlaylistTrack, Track, Customer\nThought: I should look at the schema of the relevant tables to see what columns I can use.\nAction: schema_sql_db\nAction Input: \"Invoice, Customer\"\nObservation: \nCREATE TABLE \"Customer\" (\n    \"CustomerId\" INTEGER NOT NULL, \n    \"FirstName\" NVARCHAR(40) NOT NULL, \n    \"LastName\" NVARCHAR(20) NOT NULL, \n    \"Company\" NVARCHAR(80), \n    \"Address\" NVARCHAR(70), \n    \"City\" NVARCHAR(40), \n    \"State\" NVARCHAR(40), \n    \"Country\" NVARCHAR(40), \n    \"PostalCode\" NVARCHAR(10), \n    \"Phone\" NVARCHAR(24), \n    \"Fax\" NVARCHAR(24), \n    \"Email\" NVARCHAR(60) NOT NULL, \n    \"SupportRepId\" INTEGER, \n    PRIMARY KEY (\"CustomerId\"), \n    FOREIGN KEY(\"SupportRepId\") REFERENCES \"Employee\" (\"EmployeeId\")\n)\n\nSELECT * FROM 'Customer' LIMIT 3;\nCustomerId FirstName LastName Company Address City State Country PostalCode Phone Fax Email SupportRepId\n1 Lu√≠s Gon√ßalves Embraer - Empresa Brasileira de Aeron√°utica S.A. Av. Brigadeiro Faria Lima, 2170 S√£o Jos√© dos Campos SP Brazil 12227-000 +55 (12) 3923-5555 +55 (12) 3923-5566 luisg@embraer.com.br 3\n2 Leonie K√∂hler None Theodor-Heuss-Stra√üe 34 Stuttgart None Germany 70174 +49 0711 2842222 None leonekohler@surfeu.de 5\n3 Fran√ßois Tremblay None 1498 rue B√©langer Montr√©al QC Canada H2G 1A7 +1 (514) 721-4711 None ftremblay@gmail.com 3\n\n\nCREATE TABLE \"Invoice\" (\n    \"InvoiceId\" INTEGER NOT NULL, \n    \"CustomerId\" INTEGER NOT NULL, \n    \"InvoiceDate\" DATETIME NOT NULL, \n    \"BillingAddress\" NVARCHAR(70), \n    \"BillingCity\" NVARCHAR(40), \n    \"BillingState\" NVARCHAR(40), \n    \"BillingCountry\" NVARCHAR(40), \n    \"BillingPostalCode\" NVARCHAR(10), \n    \"Total\" NUMERIC(10, 2) NOT NULL, \n    PRIMARY KEY (\"InvoiceId\"), \n    FOREIGN KEY(\"CustomerId\") REFERENCES \"Customer\" (\"CustomerId\")\n)\n\nSELECT * FROM 'Invoice' LIMIT 3;\nInvoiceId CustomerId InvoiceDate BillingAddress BillingCity BillingState BillingCountry BillingPostalCode Total\n1 2 2009-01-01 00:00:00 Theodor-Heuss-Stra√üe 34 Stuttgart None Germany 70174 1.98\n2 4 2009-01-02 00:00:00 Ullev√•lsveien 14 Oslo None Norway 0171 3.96\n3 8 2009-01-03 00:00:00 Gr√©trystraat 63 Brussels None Belgium 1000 5.94\nThought: I should query the Invoice and Customer tables to get the total sales per country.\nAction: query_sql_db\nAction Input: SELECT c.Country, SUM(i.Total) AS TotalSales FROM Invoice i INNER JOIN Customer c ON i.CustomerId = c.CustomerId GROUP BY c.Country ORDER BY TotalSales DESC LIMIT 10\nObservation: [('USA', 523.0600000000003), ('Canada', 303.9599999999999), ('France', 195.09999999999994), ('Brazil', 190.09999999999997), ('Germany', 156.48), ('United Kingdom', 112.85999999999999), ('Czech Republic', 90.24000000000001), ('Portugal', 77.23999999999998), ('India', 75.25999999999999), ('Chile', 46.62)]\nThought: I now know the final answer\nFinal Answer: The customers from the USA spent the most, with a total of $523.06.\n\n> Finished chain.\n\n'The customers from the USA spent the most, with a total of $523.06.'\n\nagent_executor.run(\n    \"Show the total number of tracks in each playlist. The Playlist name should be included in the result.\"\n)\n\n\n\n> Entering new AgentExecutor chain...\nAction: list_tables_sql_db\nAction Input: \"\"\nObservation: Invoice, MediaType, Artist, InvoiceLine, Genre, Playlist, Employee, Album, PlaylistTrack, Track, Customer\nThought: I should look at the schema of the Playlist and PlaylistTrack tables to see what columns I can use.\nAction: schema_sql_db\nAction Input: \"Playlist, PlaylistTrack\"\nObservation: \nCREATE TABLE \"Playlist\" (\n    \"PlaylistId\" INTEGER NOT NULL, \n    \"Name\" NVARCHAR(120), \n    PRIMARY KEY (\"PlaylistId\")\n)\n\nSELECT * FROM 'Playlist' LIMIT 3;\nPlaylistId Name\n1 Music\n2 Movies\n3 TV Shows\n\n\nCREATE TABLE \"PlaylistTrack\" (\n    \"PlaylistId\" INTEGER NOT NULL, \n    \"TrackId\" INTEGER NOT NULL, \n    PRIMARY KEY (\"PlaylistId\", \"TrackId\"), \n    FOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \n    FOREIGN KEY(\"PlaylistId\") REFERENCES \"Playlist\" (\"PlaylistId\")\n)\n\nSELECT * FROM 'PlaylistTrack' LIMIT 3;\nPlaylistId TrackId\n1 3402\n1 3389\n1 3390\nThought: I can use a SELECT statement to get the total number of tracks in each playlist.\nAction: query_checker_sql_db\nAction Input: SELECT Playlist.Name, COUNT(PlaylistTrack.TrackId) AS TotalTracks FROM Playlist INNER JOIN PlaylistTrack ON Playlist.PlaylistId = PlaylistTrack.PlaylistId GROUP BY Playlist.Name\nObservation: \n\nSELECT Playlist.Name, COUNT(PlaylistTrack.TrackId) AS TotalTracks FROM Playlist INNER JOIN PlaylistTrack ON Playlist.PlaylistId = PlaylistTrack.PlaylistId GROUP BY Playlist.Name\nThought: The query looks correct, I can now execute it.\nAction: query_sql_db\nAction Input: SELECT Playlist.Name, COUNT(PlaylistTrack.TrackId) AS TotalTracks FROM Playlist INNER JOIN PlaylistTrack ON Playlist.PlaylistId = PlaylistTrack.PlaylistId GROUP BY Playlist.Name LIMIT 10\nObservation: [('90‚Äôs Music', 1477), ('Brazilian Music', 39), ('Classical', 75), ('Classical 101 - Deep Cuts', 25), ('Classical 101 - Next Steps', 25), ('Classical 101 - The Basics', 25), ('Grunge', 15), ('Heavy Metal Classic', 26), ('Music', 6580), ('Music Videos', 1)]\nThought: I now know the final answer.\nFinal Answer: The total number of tracks in each playlist are: '90‚Äôs Music' (1477), 'Brazilian Music' (39), 'Classical' (75), 'Classical 101 - Deep Cuts' (25), 'Classical 101 - Next Steps' (25), 'Classical 101 - The Basics' (25), 'Grunge' (15), 'Heavy Metal Classic' (26), 'Music' (6580), 'Music Videos' (1).\n\n> Finished chain.\n\n\"The total number of tracks in each playlist are: '90‚Äôs Music' (1477), 'Brazilian Music' (39), 'Classical' (75), 'Classical 101 - Deep Cuts' (25), 'Classical 101 - Next Steps' (25), 'Classical 101 - The Basics' (25), 'Grunge' (15), 'Heavy Metal Classic' (26), 'Music' (6580), 'Music Videos' (1).\"\n\nRecovering from an error‚Äã\n\nIn this example, the agent is able to recover from an error after initially trying to access an attribute (Track.ArtistId) which doesn‚Äôt exist.\n\nagent_executor.run(\"Who are the top 3 best selling artists?\")\n\n\n\n> Entering new AgentExecutor chain...\nAction: list_tables_sql_db\nAction Input: \"\"\nObservation: MediaType, Track, Invoice, Album, Playlist, Customer, Employee, InvoiceLine, PlaylistTrack, Genre, Artist\nThought: I should look at the schema of the Artist, InvoiceLine, and Track tables to see what columns I can use.\nAction: schema_sql_db\nAction Input: \"Artist, InvoiceLine, Track\"\nObservation: \nCREATE TABLE \"Artist\" (\n    \"ArtistId\" INTEGER NOT NULL, \n    \"Name\" NVARCHAR(120), \n    PRIMARY KEY (\"ArtistId\")\n)\n\nSELECT * FROM 'Artist' LIMIT 3;\nArtistId Name\n1 AC/DC\n2 Accept\n3 Aerosmith\n\n\nCREATE TABLE \"Track\" (\n    \"TrackId\" INTEGER NOT NULL, \n    \"Name\" NVARCHAR(200) NOT NULL, \n    \"AlbumId\" INTEGER, \n    \"MediaTypeId\" INTEGER NOT NULL, \n    \"GenreId\" INTEGER, \n    \"Composer\" NVARCHAR(220), \n    \"Milliseconds\" INTEGER NOT NULL, \n    \"Bytes\" INTEGER, \n    \"UnitPrice\" NUMERIC(10, 2) NOT NULL, \n    PRIMARY KEY (\"TrackId\"), \n    FOREIGN KEY(\"MediaTypeId\") REFERENCES \"MediaType\" (\"MediaTypeId\"), \n    FOREIGN KEY(\"GenreId\") REFERENCES \"Genre\" (\"GenreId\"), \n    FOREIGN KEY(\"AlbumId\") REFERENCES \"Album\" (\"AlbumId\")\n)\n\nSELECT * FROM 'Track' LIMIT 3;\nTrackId Name AlbumId MediaTypeId GenreId Composer Milliseconds Bytes UnitPrice\n1 For Those About To Rock (We Salute You) 1 1 1 Angus Young, Malcolm Young, Brian Johnson 343719 11170334 0.99\n2 Balls to the Wall 2 2 1 None 342562 5510424 0.99\n3 Fast As a Shark 3 2 1 F. Baltes, S. Kaufman, U. Dirkscneider & W. Hoffman 230619 3990994 0.99\n\n\nCREATE TABLE \"InvoiceLine\" (\n    \"InvoiceLineId\" INTEGER NOT NULL, \n    \"InvoiceId\" INTEGER NOT NULL, \n    \"TrackId\" INTEGER NOT NULL, \n    \"UnitPrice\" NUMERIC(10, 2) NOT NULL, \n    \"Quantity\" INTEGER NOT NULL, \n    PRIMARY KEY (\"InvoiceLineId\"), \n    FOREIGN KEY(\"TrackId\") REFERENCES \"Track\" (\"TrackId\"), \n    FOREIGN KEY(\"InvoiceId\") REFERENCES \"Invoice\" (\"InvoiceId\")\n)\n\nSELECT * FROM 'InvoiceLine' LIMIT 3;\nInvoiceLineId InvoiceId TrackId UnitPrice Quantity\n1 1 2 0.99 1\n2 1 4 0.99 1\n3 2 6 0.99 1\nThought: I should query the database to get the top 3 best selling artists.\nAction: query_sql_db\nAction Input: SELECT Artist.Name, SUM(InvoiceLine.Quantity) AS TotalQuantity FROM Artist INNER JOIN Track ON Artist.ArtistId = Track.ArtistId INNER JOIN InvoiceLine ON Track.TrackId = InvoiceLine.TrackId GROUP BY Artist.Name ORDER BY TotalQuantity DESC LIMIT 3\nObservation: Error: (sqlite3.OperationalError) no such column: Track.ArtistId\n[SQL: SELECT Artist.Name, SUM(InvoiceLine.Quantity) AS TotalQuantity FROM Artist INNER JOIN Track ON Artist.ArtistId = Track.ArtistId INNER JOIN InvoiceLine ON Track.TrackId = InvoiceLine.TrackId GROUP BY Artist.Name ORDER BY TotalQuantity DESC LIMIT 3]\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\nThought: I should double check my query before executing it.\nAction: query_checker_sql_db\nAction Input: SELECT Artist.Name, SUM(InvoiceLine.Quantity) AS TotalQuantity FROM Artist INNER JOIN Track ON Artist.ArtistId = Track.ArtistId INNER JOIN InvoiceLine ON Track.TrackId = InvoiceLine.TrackId GROUP BY Artist.Name ORDER BY TotalQuantity DESC LIMIT 3\nObservation: \n\nSELECT Artist.Name, SUM(InvoiceLine.Quantity) AS TotalQuantity \nFROM Artist \nINNER JOIN Track ON Artist.ArtistId = Track.ArtistId \nINNER JOIN InvoiceLine ON Track.TrackId = InvoiceLine.TrackId \nGROUP BY Artist.Name \nORDER BY TotalQuantity DESC \nLIMIT 3;\nThought: I now know the final answer.\nAction: query_sql_db\nAction Input: SELECT Artist.Name, SUM(InvoiceLine.Quantity) AS TotalQuantity FROM Artist INNER JOIN Album ON Artist.ArtistId = Album.ArtistId INNER JOIN Track ON Album.AlbumId = Track.AlbumId INNER JOIN InvoiceLine ON Track.TrackId = InvoiceLine.TrackId GROUP BY Artist.Name ORDER BY TotalQuantity DESC LIMIT 3\nObservation: [('Iron Maiden', 140), ('U2', 107), ('Metallica', 91)]\nThought: I now know the final answer.\nFinal Answer: The top 3 best selling artists are Iron Maiden, U2, and Metallica.\n\n> Finished chain.\n\n'The top 3 best selling artists are Iron Maiden, U2, and Metallica.'\n\nPrevious\nSpark SQL\nNext\nSteam Game Recommendation & Game Details Tool\nInitialization\nUsing ZERO_SHOT_REACT_DESCRIPTION\nUsing OpenAI Functions\nDisclaimer ‚ö†Ô∏è\nExample: describing a table\nExample: describing a table, recovering from an error\nExample: running queries\nRecovering from an error\nCommunity\nDiscord\nTwitter\nGitHub\nPython\nJS/TS\nMore\nHomepage\nBlog\nCopyright ¬© 2023 LangChain, Inc."
}